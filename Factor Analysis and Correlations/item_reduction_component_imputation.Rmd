---
title: "Item Reduction and Component Imputation"
author: "Alicia Vo"
date: "2025-01-30"
output: html_document
---

```{r, include=FALSE, echo=FALSE}

library(tidyverse)
library(RPostgreSQL)
library(lavaan)
#library(psych)
#library(kableExtra)
library(usethis)

# Connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("bold_vision")

source("W:\\RDA Team\\R\\Github\\RDA Functions\\main\\RDA-Functions\\Utility_Functions.R")

# Pull in data from postgres database

# Pull in the survey data and data dictionary
# svy_data <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")
# svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024")
```

# Step 2: Item Reduction and Component Imputation
<p>Use factor analysis final results to remove items from factor model. Items will be removed starting with items with a load less than 0.6. Factor analysis will then be rerun at different stages of the item reductions until all items in each component are above the threshold as items are reduced. 

Once the final set of items are determined in the model, component scores will be imputed based on the factor model. This will give us an average score for every respondent based on our factor/component model. Select items that do not fit within a factor may be carried forward as separate explanatory variables for the regression (e.g., sparks, safety).</p>

```{r}
# Pull in factor analysis table and filter for survey items that meet the 
# factor score threshold 
factor_analysis <- dbGetQuery(con, "SELECT * FROM youth_thriving.factor_analysis
                              WHERE met_threshold=true")

# Create the string names for the subcomponent and component CFA models 

# Group by models and grab each model's variables
 all_models <- factor_analysis %>%
   group_by(model_name) %>%
   summarize(variables = paste(variable, collapse = " + "), .groups = "drop")

 # Create model strings for CFA
 all_models_strings <- all_models %>%
   mutate(model_string = paste0(
     model_name, "_model",
     " <- ",
     model_name,
     " =~ '",
     variables, "'"))

 # Display all the model strings
 all_models_strings$model_string
```

```{r}
component_caring_families_and_relationships_model <- component_caring_families_and_relationships =~ 'dl + dk + dn'  
component_cultural_identity_model <- component_cultural_identity =~ 'dz + dy + dx + ea + eb + ec'  
component_positive_identity_and_self_worth_model <- component_positive_identity_and_self_worth =~ 'co + cp + de + dd + df + cn'  
component_racial_justice_equity_and_inclusion_model <- component_racial_justice_equity_and_inclusion =~ 'ek + el + ei + em + en + ej + eh + ef + eg + ep + et + ew + eu + eq + eo + er + es + ev + ey + ex'  
component_safety_model <- component_safety =~ 'q19'  
component_strong_minds_model <- component_strong_minds =~ 'cy + cu + cw + cv + ct + cx'  
component_vibrant_communities_model <- component_vibrant_communities =~ 'dq + du + dp + dr + dv + dt + do + ds'  
positive_identity_and_self_worth_AND_strong_minds_model <- positive_identity_and_self_worth_AND_strong_minds_model =~ 'cy + cu + co + cp + cw + cn + cm + cr + dd + de'  
subcomponent_connectedness_model <- subcomponent_connectedness =~ 'dk + dl'  
subcomponent_critical_action_model <- subcomponent_critical_action =~ 'dm'  
subcomponent_experiences_of_racism_and_discrimination_model <- subcomponent_experiences_of_racism_and_discrimination =~ 'ek + el + ei + en + em + ej + eh + ef + eg'  
subcomponent_freedom_to_explore_the_self_model <- subcomponent_freedom_to_explore_the_self =~ 'de + dd + df'  
subcomponent_growth_mindset_model <- subcomponent_growth_mindset =~ 'cr'  
subcomponent_hope_for_the_future_model <- subcomponent_hope_for_the_future =~ 'co + cp'  
subcomponent_microaggressions_model <- subcomponent_microaggressions =~ 'ep + eq + eo + er'  
subcomponent_personal_safety_model <- subcomponent_personal_safety =~ 'q19'  
subcomponent_positive_emotions_model <- subcomponent_positive_emotions =~ 'cl + cm + ck'  
subcomponent_psychological_distress_model <- subcomponent_psychological_distress =~ 'cy + cu + cw + cv + ct + cx'  
subcomponent_relationships_support_model <- subcomponent_relationships_support =~ 'dn + q12a'  
subcomponent_self_efficacy_model <- subcomponent_self_efficacy =~ 'cn'  
subcomponent_sparks_model <- subcomponent_sparks =~ 'q10'  
subcomponent_structural_racism_model <- subcomponent_structural_racism =~ 'et + ew + ey + eu + ev + es + ex'  
```

```{r, include=FALSE, echo=FALSE}
# Contains all the component models that have 3 or more question items 
component_models <- c(
  component_caring_families_and_relationships_model,
  component_cultural_identity_model,
  component_positive_identity_and_self_worth_model, 
  component_racial_justice_equity_and_inclusion_model,
  component_strong_minds_model,
  component_vibrant_communities_model
)

# Contains all the subcomponent models that have 3 or more question items 
subcomponent_models <- c(
  subcomponent_experiences_of_racism_and_discrimination_model,
  subcomponent_freedom_to_explore_the_self_model, 
  subcomponent_microaggressions_model,
  subcomponent_positive_emotions_model, 
  subcomponent_psychological_distress_model,
  subcomponent_relationships_support_model, 
  subcomponent_structural_racism_model
)

# Contains all the subcomponent and component models that have less than 3 question items
remaining_models <- c(
  component_safety_model, 
  subcomponent_connectedness_model, 
  subcomponent_critical_action_model, 
  subcomponent_growth_mindset_model, 
  subcomponent_hope_for_the_future_model, 
  subcomponent_personal_safety_model, 
  subcomponent_self_efficacy_model, 
  subcomponent_sparks_model 
)
```

```{r, include=FALSE, echo=FALSE}
# Create a function for the entire process of confirmatory factor analysis (CFA),
# including the model fit measures (only ran if the model is determined to be a good fit).
# Also impute the scores.

run_cfa <- function(model_name) {
  # If the model is determined to be a good fit, then obtain the factor loadings. 
  # AV 12/6/24: The if statement is commented out for now, in order to see the factor loading scores regardless of the results of the model fit measures
  
 #if(run_model_fit_measures(model_name)==TRUE) {
  
    # Fit the data to a CFA model
    fit.cat <- cfa(model_name, data=small_svy_data, std.lv = TRUE,
               ordered = TRUE)
    # Define threshold for factor loadings
    threshold_factor_loading <- 0.6
    
    # Extract factor loadings and filter by threshold
    loadings_summary <- parameterEstimates(fit.cat, standardized = TRUE) %>% 
      filter(op == "=~") %>% 
      select(variable = rhs, factor_loading = est, ci.lower, ci.upper, se, p_value = pvalue) %>%
      mutate(met_threshold = abs(factor_loading) >= threshold_factor_loading) %>%
      arrange(desc(factor_loading)) # Reorder by factor_loading score in descending order
          
    # Count how many loadings met the threshold
    count_met_threshold <- loadings_summary %>%
      filter(met_threshold) %>%
      nrow()
    
    # Extract the part before the =~
    short_model_name <- sub(" =~.*", "", model_name)
    
    # Print results
    cat(short_model_name, "\n", "Number of factor loadings meeting the threshold 
        (>=", threshold_factor_loading, "):", count_met_threshold, 
        "out of", ... = nrow(loadings_summary), "items", "\n")
    print(loadings_summary)
    cat("\n")
    
    # Select specific columns from small_svy_dd for the merge
    small_svy_dd_selected <- small_svy_dd %>%
    select(variable, question, sub_question, question_number,response_domain,variable_name)
    
    # Run model fit measures if the model uses 3 or more questions 
    if(nrow(loadings_summary)<3)
    {
      fit_measures_df <- data.frame(cfi = NA, tli = NA, rmsea = NA, srmr = NA)
    }
    else
    {
      fit_measures <- fitMeasures(fit.cat,c("cfi","tli","rmsea","srmr"))
      # Convert fit_measures into a data frame
      fit_measures_df <- as.data.frame(t(as.matrix(fit_measures)))
    }

    # Calculate overall factor scores for the model
    factor_scores <- lavPredict(fit.cat)
    print(factor_scores)
    
    # Create a dataframe with the summary results
    results_df <- loadings_summary %>%
    mutate(model_name = short_model_name,
           count_met_threshold = count_met_threshold,
           total_vars = nrow(loadings_summary)) %>%
    bind_cols(fit_measures_df) %>%
    left_join(small_svy_dd_selected, by = c("variable")) %>% 
    relocate(model_name, question, sub_question, factor_loading, met_threshold) 
    
    # Return the dataframe
    return(results_df)
 # }
}
```

```{r, include=FALSE, echo=FALSE}
# This model is used for testing the run_cfa function since it's a small model 
test_model <- 'test =~ dk + dl + dm + dx'
fit.cat <- run_cfa(test_model, data=small_svy_data, std.lv = TRUE, ordered = TRUE)
```

```{r}
# Run confirmatory factor analysis (CFA) on the models

# Get factor loadings for the components
component_results <- do.call(rbind, lapply(component_models, run_cfa))

# Get factor loadings for the subcomponents
subcomponent_results <- do.call(rbind, lapply(subcomponent_models, run_cfa))

# Get factor loadings for the components and subcomponents with less than 3 items
remaining_results <- do.call(rbind, lapply(remaining_models, run_cfa))
```



