---
title: Bold Vision Youth Thriving Survey Frequency Counts by Domain Areas 
output:
  html_document:
    code_folding: hide
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# source("W:\\Project\\OSI\\Bold Vision\\Youth Thriving Survey\\R\\analysis_functions.R")
library(data.table)
library(dplyr)
library(RPostgreSQL)
library(sf)
library(tidyr)
library(readxl)
library(tidyverse)
library(janitor)
library(srvyr)
library(survey)
library(highcharter)
library(knitr)
library(kableExtra)
options(scipen=999)

##### 1a Make sure to open script with UTF-8 encoding ######

# connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("bold_vision")

#### Step 2: Pull in and prep data ####
svy_data <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")
svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND variable != 'cbo_involvement'")

```

# Demographics

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'demographic'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>% 
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

# Strong minds

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Strong minds'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white")) 

  print(visual) 

}

```

# Positive identity and self-worth

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Positive identity and self-worth'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))


  print(visual) 

}

```

# Caring Families and Relationships

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Caring Families and Relationships'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))


  print(visual) 

}

```

# Positive identity and self-worth

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Positive identity and self-worth'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

# Vibrant Communities

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Vibrant Communities'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

# Interrelated domain

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Interrelated domain'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

# Racial justice, equity, and inclusion

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Racial justice, equity, and inclusion'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

# Safety

```{r, message = FALSE, results='asis'}

dd_filter <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc' AND response_domain = 'Safety'")

unique_indicators <- unique(dd_filter$variable)

knitr::opts_chunk$set(echo = FALSE)
#### Step 3: Run Loop Funcion to produce tables ####
for (var_string in unique_indicators) {

  dict <- dd_filter %>% filter(variable == var_string) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "responses",
                 values_to = paste0(var_string, "_labels"),
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))


  df_var <- as_survey(svy_data, weights = weights_final) %>%
    group_by(!!rlang::ensym(var_string)) %>%
    summarise(frequency = n()) %>%
    mutate(percent = round(frequency/sum(frequency)*100, 1))

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(var_string), by.y = c("variable_merge_col")) %>%
    relocate(paste0(var_string, "_labels")) %>% select(1, 3:8)

  visual <- print(kable(as.data.frame(df_final), "html") %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#5E17EB", color = "white"))

  print(visual) 

}

```

```{r, echo=FALSE}
dbDisconnect(con)
```
