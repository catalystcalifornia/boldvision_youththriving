---
title: Correlation Analysis by Subcomponent and Component  
subtitle: Bold Vision Youth Thriving Survey 2024
author: Catalyst California in collaboration with Bold Vision
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dplyr)
library(RPostgreSQL)
library(sf)
library(tidyr)
library(tidyverse)
library(srvyr)
library(survey)
library(knitr)
library(kableExtra)
library(weights)
library(corrplot)
library(Hmisc)
options(scipen=999)

# connect to postgres and pull credentials
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("bold_vision")

dt_avg_scores <- dbGetQuery(con, "SELECT * FROM youth_thriving.avg_scores") %>%
rename( 'Positive Emotions' = "positiveemotions_sc_score",
'Self Efficacy' = "selfefficacy_sc_score",
'Hope for the Future' = "hopeforthefuture_sc_score",
'Growth Mindset' = "growthmindset_sc_score",
'Psychological Distress' = "psychologicaldistress_sc_score",
'Sparks' = "sparks_sc_score", #WILL NOT INCLUDE LATER BECAUSE THERE IS A HIGH NUMBER OF NAs 
'Relationships & Support' = "relationshipssupport_sc_score",
'Freedom to Explore Self' = "freedomtoexploretheself_sc_score",
'Connectedness' = "connectedness_sc_score",
'Critical Action' = "criticalaction_sc_score",
'Access to Public Spaces' = "safeaccesstopublicspaces_sc_score",
'Cultural Identity & Connection' = "culturalidentityandconnection_sc_score",
'Experiences of Racism' = "experiencesofracismanddiscrimination_sc_score",
'Microaggressions' = "microaggressions_sc_score",
'Structural Racism' = "structuralracism_sc_score",
'Personal Safety' = "personalsafety_sc_score",
'Strong Minds' = "strongminds_comp_score",
'Positive Identity & Self Worth' = "positiveidentityandselfworth_comp_score",
'Caring Families & Relationships' = "caringfamiliesandrelationships_comp_score",
'Vibrant Communities' = "vibrantcommunities_comp_score",
'Cultural Identity' = "culturalidentity_comp_score",
'Racial Justice, Equity, & Inclusion' = "racialjusticeequityandinclusion_comp_score",
'Safety' = "safety_comp_score"
)

##Colors

gray <- "#D6D7D6"
pink <- "#F75EC1"
dark_pink <- "#EF4A66"
orange <- "#F57E20"
yellow <- "#FFBF00"
light_green <- "#00A75A"
dark_green <- "#00864A"
blue  <- "#2A12B2"
light_blue <- "#465adc"
```

## Correlation Analysis by Subcomponent 

### All Subcomponents 
```{r, fig.width=8, fig.height=8}
dt_select <-  dt_avg_scores %>%
  # order columns by component
  select('Positive Emotions',
'Growth Mindset',
'Psychological Distress',
'Self Efficacy',
'Hope for the Future',
# 'Sparks', too many NAs
'Freedom to Explore Self',
'Critical Action',
'Relationships & Support',
'Connectedness',
'Access to Public Spaces',
'Personal Safety',
'Experiences of Racism',
'Microaggressions',
'Structural Racism',
'Cultural Identity & Connection') %>%
drop_na() # drop observations with NA

# # Custom colors for the group headers
# group_colors <- c(dark_pink, pink, yellow, dark_green, light_blue, blue, light_green)
# 
# # Create a grouping vector for headers/dividers
# groups <- c(
#   rep("Strong Minds", 3),         # Group 1
#   rep("Positive Identity & Self Worth", 5),           # Group 2
#   rep("Caring Families & Relationships", 2), # Group 3
#   rep("Vibrant Communities", 1), # Group 4
#   rep("Cultural Identity", 1),         # Group 5
#   rep("Racial Justice, Equity, & Inclusion", 3),          # Group 6
#   rep("Safety", 1) # Group 7 
# )

# Compute Spearman correlation matrix (no need to reorder dt_select here)
mydata.cor2 = cor(dt_select, method = "spearman")

# Statistical significance test for correlations
testRes2 = cor.mtest(dt_select, method = "spearman", conf.level = 0.95, exact = FALSE)

# Assign colors to variables according to their group directly
# We will match the color based on the group the variable belongs to

# # Create a vector of colors for each label
# group_colors_assigned <- unlist(lapply(groups, function(x) rep(group_colors[which(unique(groups) == x)], length.out = sum(groups == x))))

# Create the correlation plot with custom group colors and grid
corrplot(
  mydata.cor2,
  type = 'full',
  p.mat = testRes2$p,
  insig = 'blank',
  diag = FALSE,
  tl.col = c(dark_pink,dark_pink, dark_pink, pink,pink,pink,pink,yellow, yellow,dark_green, light_green, blue, blue, blue, light_blue), # Apply the custom group colors to the text labels
  addgrid.col = "black" # Add grid lines to emphasize group separation
)


# store data in a dataframe
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    var_1 = rownames(cormat)[row(cormat)[ut]],
    var_2 = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
res_m<-rcorr(as.matrix(dt_select)) # run correlation matrix again
corr_df<-flattenCorrMatrix(res_m$r, res_m$P)

```

<!-- ### Strong Minds  -->

<!-- ```{r} -->
<!-- dt_select <-  dt_avg_scores %>% -->
<!--   select('Positive Emotions', 'Growth Mindset', 'Psychological Distress') %>% -->
<!--    na.omit() -->

<!-- mydata.cor2 = cor(dt_select, method="spearman") -->

<!-- testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->

<!-- corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->

<!-- ### Positive Identity and Self Worth  -->

<!-- ```{r} -->
<!-- dt_select <-  dt_avg_scores %>% -->
<!--   select("Freedom to Explore", -->
<!-- "Hope for the Future", -->
<!-- "Critical Action", -->
<!-- "Self Efficacy") %>% -->
<!--    na.omit() -->

<!-- mydata.cor2 = cor(dt_select, method="spearman") -->

<!-- testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->

<!-- corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->


<!-- ### Caring Families & Relationships -->

<!-- ```{r} -->
<!-- dt_select <-  dt_avg_scores %>% -->
<!--   select("Connectedness", -->
<!-- "Relationships/Support") %>% -->
<!--    na.omit() -->

<!-- mydata.cor2 = cor(dt_select, method="spearman") -->

<!-- testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->

<!-- corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->

<!-- ### Vibrant Communities  -->
<!-- NO GRAPH FOR THIS ONE COMPARING SUBCOMPONENTS, ONLY ONE SUBCOMPONENT -->

<!-- ```{r} -->
<!-- # dt_select <-  dt_avg_scores %>% -->
<!-- #   select("Safe Access") %>% -->
<!-- #    na.omit() -->
<!-- #  -->
<!-- # mydata.cor2 = round(cor(dt_select, method="spearman"),1) -->
<!-- #  -->
<!-- # testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->
<!-- #  -->
<!-- # corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->
<!-- ### Cultural Identity  -->
<!-- NO GRAPH FOR THIS ONE COMPARING SUBCOMPONENTS, ONLY ONE SUBCOMPONENT -->

<!-- ```{r} -->
<!-- # dt_select <-  dt_avg_scores %>% -->
<!-- #   select("Cultural Identity & Connections") %>% -->
<!-- #    na.omit() -->
<!-- #  -->
<!-- # mydata.cor2 = round(cor(dt_select, method="spearman"),1) -->
<!-- #  -->
<!-- # testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->
<!-- #  -->
<!-- # corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->

<!-- ### Racial Justice, Equity, & Inclusion -->

<!-- ```{r} -->
<!-- dt_select <-  dt_avg_scores %>% -->
<!--   select("Microaggressions", -->
<!-- "Experiences of Racism", -->
<!-- "Structural Racism") %>% -->
<!--    na.omit() -->

<!-- mydata.cor2 = round(cor(dt_select, method="spearman"),1) -->

<!-- testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->

<!-- corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->

<!-- ### Safety  -->
<!-- NO GRAPH FOR THIS ONE COMPARING SUBCOMPONENTS, ONLY ONE SUBCOMPONENT -->

<!-- ```{r} -->
<!-- # dt_select <-  dt_avg_scores %>% -->
<!-- #   select("Personal Safety") %>% -->
<!-- #    na.omit() -->
<!-- #  -->
<!-- # mydata.cor2 = round(cor(dt_select, method="spearman"),1) -->
<!-- #  -->
<!-- # testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE) -->
<!-- #  -->
<!-- # corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE) -->

<!-- ``` -->


## Correlation Analysis by Components 
```{r}
dt_select <-  dt_avg_scores %>%
  select('Strong Minds',
'Positive Identity & Self Worth',
'Caring Families & Relationships',
'Vibrant Communities',
'Cultural Identity',
'Racial Justice, Equity, & Inclusion',
'Safety') %>%
   na.omit()

mydata.cor2 = cor(dt_select, method="spearman")

testRes2 = cor.mtest(dt_select, method="spearman", conf.level = 0.95,exact=FALSE)

corrplot(round(mydata.cor2,1), type='full', p.mat=testRes2$p, insig='blank', diag=FALSE)

```

## Correlation Analysis by Demographics

### Race by Subcomponents 

```{r}
dt_race <-  dbGetQuery(con, "SELECT * FROM youth_thriving.race_ethnicity_data") 

dt_race_bipoc <- dt_race %>% select(response_id, race_black, race_aian, race_indigenous, race_latinx, race_asian, race_swana, race_nhpi, race_white) %>% 
  mutate(bipoc = ifelse(race_white == 1, 0, 1))%>%
  mutate(across(everything(), ~replace(., is.na(.), 0))) 


dt_join <- left_join(dt_avg_scores, dt_race_bipoc, by = "response_id") %>%
  na.omit() 

dt_select <-  dt_join %>%
  select('bipoc',
         'race_black',
         'race_aian', 
         'race_indigenous', 
         'race_latinx', 
         'race_asian', 
         'race_swana', 
         'race_nhpi', 
         'race_white',
          'Positive Emotions',
          'Growth Mindset',
          'Psychological Distress',
          'Self Efficacy',
          'Hope for the Future',
          # 'Sparks', too many NAs
          'Freedom to Explore',
          'Critical Action',
          'Relationships/Support',
          'Connectedness',
          'Safe Access',
          'Cultural Identity & Connections',
          'Experiences of Racism',
          'Microaggressions',
          'Structural Racism',
          'Personal Safety',) %>%
   na.omit()


# Compute Spearman correlation matrix (no need to reorder dt_select here)
mydata.cor2 = cor(dt_select, method = "spearman")

# Statistical significance test for correlations
testRes2 = cor.mtest(dt_select, method = "spearman", conf.level = 0.95, exact = FALSE)

corrplot(
  mydata.cor2,
  type = 'full',
  p.mat = testRes2$p,
  insig = 'blank',
  diag = FALSE,
  # addCoef.col = 'black',
  # col = COL2('PuOr', 10),
  tl.col = c("black", "black", "black", "black", "black", "black", "black","black","black", dark_pink,dark_pink, dark_pink, pink,pink,pink,pink,pink, yellow,yellow, dark_green, light_blue, blue, blue, blue, light_green), # Apply the custom group colors to the text labels
  addgrid.col = "black" # Add grid lines to emphasize group separation
)


```

### Race by Components 

```{r}

dt_select <-  dt_join %>%
  select('bipoc',
         'race_black',
         'race_aian', 
         'race_indigenous', 
         'race_latinx', 
         'race_asian', 
         'race_swana', 
         'race_nhpi', 
         'race_white',
          'Strong Minds',
          'Positive Identity & Self Worth',
          'Caring Families & Relationships',
          'Vibrant Communities',
          'Cultural Identity',
          'Racial Justice, Equity, & Inclusion',
          'Safety') %>%
   na.omit()


# Compute Spearman correlation matrix (no need to reorder dt_select here)
mydata.cor2 = cor(dt_select, method = "spearman")

# Statistical significance test for correlations
testRes2 = cor.mtest(dt_select, method = "spearman", conf.level = 0.95, exact = FALSE)

corrplot(
  mydata.cor2,
  type = 'full',
  p.mat = testRes2$p,
  insig = 'blank',
  diag = FALSE,
  # addCoef.col = 'black',
  # col = COL2('PuOr', 10),
  tl.col = c("black", "black", "black", "black", "black", "black", "black","black","black",dark_pink, pink, yellow, dark_green, light_blue, blue, light_green), # Apply the custom group colors to the text labels
  addgrid.col = "black" # Add grid lines to emphasize group separation
)



```



### Other Demographics by Subcomponents 

```{r}

dt_gender <- dbGetQuery(con, "SELECT response_id, cishet_lgbtqia FROM youth_thriving.gender_sexuality_data") %>%
  rename(LGBTQIA = cishet_lgbtqia) %>%
  mutate(across(everything(), ~replace(., is.na(.), 0))) 

dt_otherdemos <- dbGetQuery(con, "SELECT response_id, q24,q25, q26, q27, q28 FROM youth_thriving.raw_survey_data") %>%
  mutate('Systems Impacted' = ifelse(q24 == 1, 1, 0),
         'Detained/Arrested' = ifelse(q25 == 1, 1, 0),
         'Suspended' = ifelse(q26 == 1, 1, 0),
         'Undocumented' = ifelse(q27 == 1, 1, 0),
         'Unhoused' = ifelse(q28 == 1, 1, 0)) %>% 
  select('response_id', 'Systems Impacted',
         'Detained/Arrested',
         'Suspended',
         'Undocumented',
         'Unhoused') %>%
  mutate(across(everything(), ~replace(., is.na(.), 0))) 


dt_join <- left_join(dt_avg_scores, dt_gender, by = "response_id") 

dt_join_2 <- left_join(dt_join, dt_otherdemos, by = "response_id") %>%
     na.omit()

dt_select <-  dt_join_2 %>%
  select('LGBTQIA',
         'Systems Impacted',
         'Detained/Arrested',
         'Suspended',
         'Undocumented',
         'Unhoused',
          'Positive Emotions',
          'Growth Mindset',
          'Psychological Distress',
          'Self Efficacy',
          'Hope for the Future',
          # 'Sparks', too many NAs
          'Freedom to Explore',
          'Critical Action',
          'Relationships/Support',
          'Connectedness',
          'Safe Access',
          'Cultural Identity & Connections',
          'Experiences of Racism',
          'Microaggressions',
          'Structural Racism',
          'Personal Safety',) %>%
   na.omit()


# Compute Spearman correlation matrix (no need to reorder dt_select here)
mydata.cor2 = cor(dt_select, method = "spearman")

# Statistical significance test for correlations
testRes2 = cor.mtest(dt_select, method = "spearman", conf.level = 0.95, exact = FALSE)

corrplot(
  mydata.cor2,
  type = 'full',
  p.mat = testRes2$p,
  insig = 'blank',
  diag = FALSE,
  # addCoef.col = 'black',
  # col = COL2('PuOr', 10),
  tl.col = c("black", "black", "black", "black", "black", "black", dark_pink,dark_pink, dark_pink, pink,pink,pink,pink,pink, yellow,yellow, dark_green, light_blue, blue, blue, blue, light_green), # Apply the custom group colors to the text labels
  addgrid.col = "black" # Add grid lines to emphasize group separation
)


```

### Other Demographics by Components 

```{r}

dt_select <-  dt_join_2 %>%
  select('LGBTQIA',
         'Systems Impacted',
         'Detained/Arrested',
         'Suspended',
         'Undocumented',
         'Unhoused',
          'Strong Minds',
          'Positive Identity & Self Worth',
          'Caring Families & Relationships',
          'Vibrant Communities',
          'Cultural Identity',
          'Racial Justice, Equity, & Inclusion',
          'Safety') %>%
   na.omit()


# Compute Spearman correlation matrix (no need to reorder dt_select here)
mydata.cor2 = cor(dt_select, method = "spearman")

# Statistical significance test for correlations
testRes2 = cor.mtest(dt_select, method = "spearman", conf.level = 0.95, exact = FALSE)

corrplot(
  mydata.cor2,
  type = 'full',
  p.mat = testRes2$p,
  insig = 'blank',
  diag = FALSE,
  # addCoef.col = 'black',
  # col = COL2('PuOr', 10),
  tl.col = c("black", "black", "black", "black", "black", "black",dark_pink, pink, yellow, dark_green, light_blue, blue, light_green), # Apply the custom group colors to the text labels
  addgrid.col = "black" # Add grid lines to emphasize group separation
)



```


```{r, include=FALSE, echo=FALSE}

dbDisconnect(con)

```