---
title: "SEM"
author: "Alicia Vo"
date: "2025-02-10"
output: html_document
---
# Step 0: Data Preparation

```{r, include=FALSE, echo=FALSE}
options(scipen=999) # Turn off scientific notation

library(tidyverse)
library(RPostgreSQL)
library(lavaan)
library(psych)

# Used to get RDA function for adding table comments
source("W:\\RDA Team\\R\\Github\\RDA Functions\\main\\RDA-Functions\\Utility_Functions.R")

# Connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("bold_vision")

# Pull in the survey data and data dictionary
raw_svy_data <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")
svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024")
```

```{r, include=FALSE, echo=FALSE}
# Filter svy_dd and raw_svy_data to only contain the likert questions needed for the factor analysis

# In the data dictionary, variable_name = subcomponent and response_domain = component
subcomponent_list <- c("Positive Emotions", "Self-Efficacy", "Hope For The Future", "Growth Mindset", "Psychological Distress", "Sparks", "Relationships/Support", "Freedom To Explore The Self", "Connectedness", "Critical Action", "Safe Access To Public Spaces For Social, Cultural, And Literary Opportunities", "Cultural Identity And Connection", "Experiences Of Racism And Discrimination", "Microaggressions", "Structural Racism", "Personal Safety")

component_list <- c("Strong Minds", "Positive Identity And Self-Worth", "Caring Families And Relationships", "Vibrant Communities", "Cultural Identity", "Racial Justice, Equity, And Inclusion", "Safety")

# small_svy_dd only contains the likert questions needed for the factor analysis
small_svy_dd <- svy_dd %>%
  filter(response_domain %in% component_list & !(is.na(likert_type)))

# small_svy_data only contains the columns of likert questions needed for the factor analysis
small_svy_data <- raw_svy_data %>%
  select(response_id, all_of(small_svy_dd$variable))
```

```{r, include=FALSE, echo=FALSE}
# In the survey data, change the responses of "Don't wish to answer", "Not sure", "Not Sure", "Does not apply to me", "Don't know" into NA values. Use this na_responses if trying to replicate results from Step 1. Here, we recode the "Don't know" responses into NA values. 
#na_responses <- c("Don't wish to answer", "Not sure", "Not Sure", "Does not apply to me", "Don't know")

# In the survey data, change the responses of "Don't wish to answer", "Not sure", "Not Sure", "Does not apply to me" into NA values. Use this na_responses if trying to replicate results from Step 2. Here, we don't recode the "Don't know" responses into NA values. Note that the "Don't know" responses are only applicable to the "Vibrant Communities" questions in small_svy_dd.
na_responses <- c("Don't wish to answer", "Not sure", "Not Sure", "Does not apply to me")

# Iterate over each column in small_svy_data
for (col in names(small_svy_data)) {
  # Get the corresponding row in the data dictionary
  dd_row <- small_svy_dd[small_svy_dd$variable == col, ]
  
  if (nrow(dd_row) > 0) { # Ensure there is a matching dictionary entry
    # Get response_# columns
    valid_responses <- dd_row[1, grepl("^response_[0-9]+$", names(dd_row))]
    valid_responses <- valid_responses[!is.na(valid_responses)]  # Exclude NAs explicitly
    # Create response_map only if valid responses exist
    if (length(valid_responses) > 0) {
      response_map <- setNames(as.list(valid_responses), seq_along(valid_responses))
      # Replace values in the column based on the response map
      small_svy_data[[col]] <- unlist(lapply(small_svy_data[[col]], function(x) {
        if (!is.na(x) && response_map[[as.character(x)]] %in% na_responses) {
          NA
        } else {
          x
        }
      }))
    }
  }
}
```

```{r, include=FALSE, echo=FALSE}
# This chunk is needed for running factor score predictions in Step 2. For component "Vibrant Communities", we are recoding the "Don't know" responses to "No", instead of NA. There are too many "Don't know" responses for this component, causing us to have too many NA values, and thus, too many incomplete rows in predicted_results.

small_svy_data <- small_svy_data %>%
  mutate(across(c(do, dp, dq, dr, ds, dt, du, dv), ~ ifelse(. == 3, 1, .)))
```

```{r, include=FALSE, echo=FALSE}
# Reverse the likert scales in the survey data for the scales that need reversing

# Identify columns to reverse
columns_to_reverse <- small_svy_dd$variable[grep("_rev$", small_svy_dd$likert_type)]

# q10 is a special case of scale reversal; swap values 1 and 2
columns_to_reverse <- columns_to_reverse[columns_to_reverse != "q10"]
small_svy_data$q10 <- ifelse(
  is.na(small_svy_data$q10), 
  NA, 
  ifelse(small_svy_data$q10 == 1, 2, 
         ifelse(small_svy_data$q10 == 2, 1, small_svy_data$q10))
)

# Loop through each column to reverse
for (col in columns_to_reverse) {
  # Get the maximum scale value from the 'likert' column
  scale_max <- as.numeric(sub("pt_scale", "", small_svy_dd$likert[small_svy_dd$variable == col]))
  # Reverse the scale in small_svy_data
  small_svy_data[[col]] <- ifelse(is.na(small_svy_data[[col]]),
                                NA,
                                scale_max + 1 - small_svy_data[[col]])
}
```

```{r}
# Create df svy_data, which contains all the columns of raw_survey_data, but the matching columns from small_svy_data are used instead.

# Get the common columns between raw_svy_data and small_svy_data, except for response_id
matching_cols <- intersect(names(raw_svy_data), names(small_svy_data))
matching_cols <- matching_cols[!matching_cols %in% c("response_id")]

# Replace matching columns in raw_svy_data with those from small_svy_data to make the new df, svy_data
svy_data <- raw_svy_data %>%
  select(-all_of(matching_cols)) %>% # Drop matching columns
  left_join(small_svy_data, by = "response_id") # Re-add them from small_svy_data
```

```{r, include=FALSE, echo=FALSE}
# Edit svy_data to prep for SEM: Add subcomponent_experiences_of_racism_and_discrimination to the dataframe and make new column growth_mindset.

subcomponent_experiences_of_racism_and_discrimination <- dbGetQuery(con, "SELECT response_id, subcomponent_experiences_of_racism_and_discrimination_sum FROM youth_thriving.factor_analysis_predicted")

svy_data <- svy_data %>%
  left_join(subcomponent_experiences_of_racism_and_discrimination, 
            by="response_id") %>%
  mutate(growth_mindset = rowMeans(across(c(cr, cs)), na.rm = TRUE))
```
Demographics 
  x  Race (non-Hispanic ACS categories) (binary/categorical) 
  x  SOGI/LGBTQIA+ (binary Y/N) 
  x  At any point system involved (binary Y/N) 
  x  Housing status (binary Y/N) 
  x  Age (binary minor/adult): age_minor_adult
  x  Service Planning Area (binary/categorical): org_spa 
  x  Ever suspended/expelled/transferred (binary Y/N) 
  x  Poverty by ZIP Code (continuous) 
  x  Documentation Status (binary Y/N) 
```{r}
demographics_binary_data <- dbGetQuery(con, "SELECT response_id, systems_impacted, suspended, undocumented, unhoused FROM youth_thriving.demographics_binary_data")

gender_sexuality_data <- dbGetQuery(con, "SELECT response_id, cishet_lgbtqia FROM youth_thriving.gender_sexuality_data")

race_ethnicity_data <- dbGetQuery(con, "SELECT response_id, acs_race FROM youth_thriving.race_ethnicity_data")
# Create binary columns for each unique acs_race value
race_ethnicity_acs <- race_ethnicity_data %>%
  mutate(value = 1) %>%  # Create a helper column for pivoting
  pivot_wider(names_from = acs_race, values_from = value, values_fill = 0) 

poverty_rates <- dbGetQuery(con, "SELECT response_id, perc_below_100_fpl FROM youth_thriving.povery_rates_acs_23")  

# Merge all data frames into svy_data using response_id
svy_data <- svy_data %>%
  left_join(demographics_binary_data, by = "response_id") %>%
  left_join(gender_sexuality_data, by = "response_id") %>%
  left_join(race_ethnicity_acs, by = "response_id") %>%
  left_join(poverty_rates, by = "response_id")

# Create binary column is_adult
svy_data <- svy_data %>%
  mutate(is_adult = ifelse(age_minor_adult == 1, 0, 
                           ifelse(age_minor_adult == 2, 1, NA)))
# Create binary columns for SPAs
svy_data <- svy_data %>%
  mutate(org_sp_an = as.character(org_sp_an)) %>%  # Ensure it's character to work with pivoting
  filter(!is.na(org_sp_an)) %>%  # Remove NA values
  mutate(value = 1) %>%  # Helper column for pivoting
  pivot_wider(names_from = org_sp_an, values_from = value, 
              names_prefix = "spa_", values_fill = 0)
```


```{r QA Check Data Prep, include=FALSE, echo=FALSE}
# QA: Check that subcomponent_experiences_of_racism_and_discrimination_sum was merged in and growth_mindset is calculated correctly
# test <- svy_data %>% select(c(subcomponent_experiences_of_racism_and_discrimination_sum, cr, cs, growth_mindset))

# QA: Check that subcomponent_experiences_of_racism_and_discrimination_sum has no NA values so that we can use FIML later on the missing data
# test <- svy_data %>% summarise_all(~sum(is.na(.)))

# QA: Check that race dummy columns were created correctly
# test <- race_ethnicity_acs%>%
#  left_join(race_ethnicity_data, by = "response_id")
```

# Step 3: Regression Analysis
```{r Model 1: all variables, include=FALSE, echo=FALSE}
# Reference groups: race is nh_white, spa is spa_1
model_1 <- '
  # Measurement model
  component_caring_families_and_relationships =~ dl + dk + dn
  component_cultural_identity =~ dz + dy + dx + ea + eb + ec
  subcomponent_microaggressions =~ ep + eq + eo + er
  subcomponent_structural_racism =~ et + ew + ey + eu + ev + es + ex
  component_vibrant_communities =~ dq + du + dp + dr + dv + dt + do + ds
  subcomponent_psychological_distress =~ cy + cu + cw + cv + ct + cx
  
  # Regression
  subcomponent_psychological_distress ~ component_caring_families_and_relationships + 
    component_cultural_identity + 
    subcomponent_microaggressions + 
    subcomponent_structural_racism + 
    component_vibrant_communities + 
    subcomponent_experiences_of_racism_and_discrimination_sum + 
    personal_safety*q19 + 
    growth_mindset + 
    opportunities_for_community_involvement*dm +
    latino + nh_asian + nh_black + nh_twoormor + nh_aian +nh_other + nh_pacisl +
    cishet_lgbtqia +
    systems_impacted +
    unhoused +
    is_adult +
    spa_2 + spa_3 + spa_4 + spa_5 + spa_6 + spa_7 + spa_8 +
    suspended + 
    perc_below_100_fpl +
    undocumented
'

## Fit SEM on model_1

# Using FIML for all variables, including the observed independent variables (e.g. personal_safety)
# Number of observations used = 3444/3444; summary(fit_1, standardized = TRUE)

# Setting std.lv = TRUE allows all factor loadings to be freely estimated instead of fixing the first loading equal to 1.0
fit_1 <- sem(model_1, data = svy_data, std.lv = TRUE, missing = "fiml.x")

sem_output_1 <- parameterEstimates(fit_1, standardized = TRUE) %>%
  filter(op %in% c("~"))
```

```{r Model 1a: only (sub)components, include=FALSE, echo=FALSE}
model_1a <- '
  # Measurement model
  component_caring_families_and_relationships =~ dl + dk + dn
  component_cultural_identity =~ dz + dy + dx + ea + eb + ec
  subcomponent_microaggressions =~ ep + eq + eo + er
  subcomponent_structural_racism =~ et + ew + ey + eu + ev + es + ex
  component_vibrant_communities =~ dq + du + dp + dr + dv + dt + do + ds
  subcomponent_psychological_distress =~ cy + cu + cw + cv + ct + cx
  
  # Regression
  subcomponent_psychological_distress ~ component_caring_families_and_relationships + 
    component_cultural_identity + 
    subcomponent_microaggressions + 
    subcomponent_structural_racism + 
    component_vibrant_communities + 
    subcomponent_experiences_of_racism_and_discrimination_sum + 
    # personal_safety*q19 + 
    # growth_mindset + 
    # opportunities_for_community_involvement*dm +
    # latino + nh_asian + nh_black + nh_twoormor + nh_aian +nh_other + nh_pacisl +
    # cishet_lgbtqia +
    # systems_impacted +
    # unhoused +
    # is_adult +
    # spa_2 + spa_3 + spa_4 + spa_5 + spa_6 + spa_7 + spa_8 +
    # suspended + 
    # perc_below_100_fpl +
    # undocumented
'
fit_1a <- sem(model_1a, data = svy_data, std.lv = TRUE, missing = "fiml.x")
 
sem_output_1a <- parameterEstimates(fit_1a, standardized = TRUE) %>%
  filter(op %in% c("~"))

# Analysis: subcomponent_experiences_of_racism_and_discrimination_sum is not statistically significant (p=0.17). The coefficient on component_vibrant_communities is small comparatively (b=0.04).
```
 
```{r Model 1b: adding 2 observed variables, minor tweaking based on analysis of previous models, include=FALSE, echo=FALSE}
model_1b <- '
  # Measurement model
  component_caring_families_and_relationships =~ dl + dk + dn
  component_cultural_identity =~ dz + dy + dx + ea + eb + ec
  subcomponent_microaggressions =~ ep + eq + eo + er
  subcomponent_structural_racism =~ et + ew + ey + eu + ev + es + ex
  component_vibrant_communities =~ dq + du + dp + dr + dv + dt + do + ds
  subcomponent_psychological_distress =~ cy + cu + cw + cv + ct + cx
  
  # Regression
  subcomponent_psychological_distress ~ component_caring_families_and_relationships + 
    component_cultural_identity + 
    subcomponent_microaggressions + 
    subcomponent_structural_racism + 
    component_vibrant_communities + 
    # subcomponent_experiences_of_racism_and_discrimination_sum + 
    personal_safety*q19 +
    growth_mindset +
    # opportunities_for_community_involvement*dm +
    # latino + nh_asian + nh_black + nh_twoormor + nh_aian +nh_other + nh_pacisl +
    # cishet_lgbtqia +
    # systems_impacted +
    # unhoused +
    # is_adult +
    # spa_2 + spa_3 + spa_4 + spa_5 + spa_6 + spa_7 + spa_8 +
    # suspended +
    # perc_below_100_fpl +
    # undocumented
'
fit_1b <- sem(model_1b, data = svy_data, std.lv = TRUE, missing = "fiml.x")
 
sem_output_1b <- parameterEstimates(fit_1b, standardized = TRUE) %>%
  filter(op %in% c("~"))

# Analysis: personal_safety is statistically significant but has a small coefficient size (b=0.08). growth_mindset is statistically significant and has the 3rd largest coefficient size (b=0.14)
``` 
 
```{r Model 1c: adding some demographics, include=FALSE, echo=FALSE}
# Systems-impacted, Q24. At any point have you: Lived in foster care, spent time in juvenile hall or probation camp, spent time in jail or prison, lived in a group home or residential program, or lived with relatives who were responsible for you legally?

model_1c <- '
  # Measurement model
  component_caring_families_and_relationships =~ dl + dk + dn
  component_cultural_identity =~ dz + dy + dx + ea + eb + ec
  subcomponent_microaggressions =~ ep + eq + eo + er
  subcomponent_structural_racism =~ et + ew + ey + eu + ev + es + ex
  component_vibrant_communities =~ dq + du + dp + dr + dv + dt + do + ds
  subcomponent_psychological_distress =~ cy + cu + cw + cv + ct + cx
  
  # Regression
  subcomponent_psychological_distress ~ component_caring_families_and_relationships + 
    component_cultural_identity + 
    subcomponent_microaggressions + 
    subcomponent_structural_racism + 
    component_vibrant_communities + 
    # subcomponent_experiences_of_racism_and_discrimination_sum + 
    personal_safety*q19 +
    growth_mindset +
    # opportunities_for_community_involvement*dm +
    latino + nh_asian + nh_black + nh_twoormor + nh_aian +nh_other + nh_pacisl +
    cishet_lgbtqia +
    systems_impacted +
    unhoused +
    # is_adult +
    # spa_2 + spa_3 + spa_4 + spa_5 + spa_6 + spa_7 + spa_8 +
    # suspended +
    perc_below_100_fpl +
    undocumented
'
fit_1c <- sem(model_1c, data = svy_data, std.lv = TRUE, missing = "fiml.x")
 
sem_output_1c <- parameterEstimates(fit_1c, standardized = TRUE) %>%
  filter(op %in% c("~"))

# Analysis: unhoused, latino, nh_pacisl, nh_twoormor, perc_below_100_fpl, and undocumented are not statistically significant.
```  
 
fix 1d 
```{r Model 1d: (sub)components and some demographics, include=FALSE, echo=FALSE}
# Systems-impacted, Q24. At any point have you: Lived in foster care, spent time in juvenile hall or probation camp, spent time in jail or prison, lived in a group home or residential program, or lived with relatives who were responsible for you legally?

model_1d <- '
  # Measurement model
  component_caring_families_and_relationships =~ dl + dk + dn
  component_cultural_identity =~ dz + dy + dx + ea + eb + ec
  subcomponent_microaggressions =~ ep + eq + eo + er
  subcomponent_structural_racism =~ et + ew + ey + eu + ev + es + ex
  component_vibrant_communities =~ dq + du + dp + dr + dv + dt + do + ds
  subcomponent_psychological_distress =~ cy + cu + cw + cv + ct + cx
  
  # Regression
  subcomponent_psychological_distress ~ component_caring_families_and_relationships + 
    component_cultural_identity + 
    subcomponent_microaggressions + 
    subcomponent_structural_racism + 
    component_vibrant_communities + 
    # subcomponent_experiences_of_racism_and_discrimination_sum + 
    # personal_safety*q19 +
    # growth_mindset +
    # opportunities_for_community_involvement*dm +
    latino + nh_asian + nh_black + nh_twoormor + nh_aian +nh_other + nh_pacisl +
    cishet_lgbtqia +
    systems_impacted +
    unhoused +
    # is_adult +
    # spa_2 + spa_3 + spa_4 + spa_5 + spa_6 + spa_7 + spa_8 +
    # suspended +
    perc_below_100_fpl +
    undocumented
'
fit_1d <- sem(model_1d, data = svy_data, std.lv = TRUE, missing = "fiml.x")
 
sem_output_1d <- parameterEstimates(fit_1d, standardized = TRUE) %>%
  filter(op %in% c("~"))

# Analysis: 
```   
 
```{r}
unique(svy_data[,c('spa_final_respondent','spa_name_final_respondent')])
```

```{r}
# Variables that are nearly perfectly correlated
round(1 - 1 / diag((solve(cov2cor(lavInspect(fit_1, "sampstats")$cov)))), 3)
```

```{r QA Check on FIML, include=FALSE, echo=FALSE}
# QA check on full information maximum likelihood (FIML) for the missing survey data

# No FIML at all                                                          
# Number of observations used = 2530/3444
fit_1a <- sem(model_1, data = svy_data, std.lv = TRUE)
summary(fit_1a, standardized = TRUE)

# FIML, but not for the observed independent variables
# Number of observations used = 3262/3444
fit_1b <- sem(model_1, data = svy_data, std.lv = TRUE, missing = "fiml")
summary(fit_1b, standardized = TRUE)
```

