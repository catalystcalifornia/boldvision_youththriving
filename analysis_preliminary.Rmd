---
title: Bold Vision Youth Thriving Survey 
subtitle: Frequencies and Trends by Question and Category
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

### Step 1: Environment set up ----

library(data.table)
library(dplyr)
library(RPostgreSQL)
library(sf)
library(tidyr)
library(readxl)
library(tidyverse)
library(janitor)
library(srvyr)
library(survey)
library(highcharter)
library(knitr)
library(kableExtra)
library(devtools) 
options(scipen=999)

# connect to postgres and source functions
source("W:\\RDA Team\\R\\credentials_source.R")
# source_url('https://github.com/catalystcalifornia/RDA-Functions/blob/main/Utility_Functions.R') 

con <- connect_to_db("bold_vision")

### Step 2: Pull in and prep data ----
svy_df <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")
svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc'")
dd_all <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 ")

# Descriptive Function -----
question_sum<-function (svy_df,svy_dd,domain,variable_target) {
df <- svy_dd%>%filter(response_domain==domain & variable_name==variable_target)

unique_vars <- unique(df$variable)

mylist<-list()

for (i in unique_vars) {

  dict <- df %>% filter(variable == i) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "response_numbers",
                 values_to = "response",
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))

  df_var<-svy_df%>%as_survey(weights=c(weights_final))%>%
    filter(!is.na(!!as.symbol(i)))%>%
    group_by(!!rlang::ensym(i))%>%
    summarise(frequency=n(),percent=survey_mean(vartype="cv",level=.90))%>%
    mutate(percent=percent*100,percent_cv=percent_cv*100)%>%
    rename(weighted_percent=percent)

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(i), by.y = c("variable_merge_col"))%>%
    select(question,sub_question,response,frequency,weighted_percent,percent_cv)
 
 #  df_table<-df_final%>%rename_with(toupper)%>%rename(PERCENT=WEIGHTED_PERCENT)
 #  colnames(df_table)<-gsub("_", " ", colnames(df_table))
 #  
 # visual <- kable(as.data.frame(df_table)%>% 
 #   mutate_if(is.numeric, format, digits=2)) %>%
 #  kable_styling("striped", full_width = F) %>%
 #  row_spec(0, background = "#2A12B2", color = "white",font_size=12)%>%
 #   footnote(general="Frequencies are unweighted counts. Percentages and coefficients of variation (CV) are weighted")


  # print(visual) 
  mylist[[i]] <- df_final

# print(mylist)
  }
all_vars_df<-dplyr::bind_rows(mylist)%>%mutate(variable=variable_target)
# return(all_vars_df)
}


# function test
# question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Positive Emotions")

# Heatmap function ----
heatmap<-function(df,factors){
df<-df

df$response <- factor(x=df$response, levels = factors)

ggplot(data = df, aes(x = response, y = sub_question,fill=weighted_percent))+
  geom_tile(color="white",lwd = 1.5,
            linetype = 1)+
  geom_text(aes(label=round(weighted_percent,1)),size=3)+
  scale_fill_gradient(low="#f9de8d", high="#EF4A66",name="Weighted Percent")+
  scale_y_discrete(labels=function(x)str_wrap(x,width=20),)+
  scale_x_discrete(labels=function(y)str_wrap(y,width=5))+
  labs(title=str_wrap(df$question,width=60),
       x="Response",
       y="")+
  coord_fixed()+
  theme_bw()+
  theme(plot.title=element_text(size=9),
        legend.title=element_text(size=9),
        axis.text.x=element_text(size=9))
}

# Factor options
true_factors<-c("Never True","Sometimes True","Often True","Always True","Don't wish to answer")

```

The following provides a summary of how youth answered each item in the Bold Vision Youth Thriving Survey for every category and construct measured.

# Strong Minds

## Positive Emotions
```{r}

sm_positive_emotions<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Positive Emotions")

# check factors
# unique(sm_positive_emotions$response)

heatmap(sm_positive_emotions,true_factors)

```

## Growth Mindset
```{r}

sm_growth_mindset<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Growth Mindset")

# check factors
# unique(sm_positive_emotions$response)

heatmap(sm_growth_mindset,true_factors)


```

## Psychological Distress
```{r}

sm_psychologicaldistress<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Psychological Distress")

# check factors
# unique(sm_psychologicaldistress$response)

time_factors<-c("None of the time","A little of the time","Some of the time","Most of the time","All of the time","dont wish to answer")

heatmap(sm_psychologicaldistress,time_factors)

```

# Positive Identity And Self-Worth

## Self-Efficacy
```{r}

pi_self<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Self-Efficacy")

# check factors
# unique(pi_self$response)

heatmap(pi_self,true_factors)

```

## Hope For The Future
```{r}

pi_hope<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Hope For The Future")

# check factors
# unique(pi_hope$response)

heatmap(pi_hope,true_factors)
```

## Freedom To Explore Self
```{r}

pi_freedom<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Freedom To Explore The Self")

# check factors
# unique(pi_freedom$response)

heatmap(pi_freedom,true_factors)

```

## Sparks
```{r}

pi_sparks<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Sparks")

# check factors
# unique(pi_sparks$response)

yes_factors<-c("Yes","No","Not sure","Don't wish to answer")

sparks<-pi_sparks%>%filter(question=="Q10. When people are really happy, energized, and passionate about their talents, interests, or hobbies, we say they have a “spark” in their life. This spark is more than just interesting or fun for them. They are passionate about it. It gives them joy and energy. It is a really important part of their life that gives them real purpose, direction, or focus. Do you have this kind of spark in your life?")%>%mutate(question="Q10. When people are really happy, energized, and passionate about their talents, interests, or hobbies, we say they have a “spark” in their life.",sub_question="Do you have this kind of spark in your life?")

heatmap(sparks,yes_factors)

sparks_table<-pi_sparks%>%filter(question!="Q10. When people are really happy, energized, and passionate about their talents, interests, or hobbies, we say they have a “spark” in their life. This spark is more than just interesting or fun for them. They are passionate about it. It gives them joy and energy. It is a really important part of their life that gives them real purpose, direction, or focus. Do you have this kind of spark in your life?")

  df_table<-sparks_table%>%rename_with(toupper)%>%rename(PERCENT=WEIGHTED_PERCENT)%>%
    select(-c(2,6:7))
  colnames(df_table)<-gsub("_", " ", colnames(df_table))

kable(as.data.frame(df_table)%>%
   mutate_if(is.numeric, format, digits=2)) %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#2A12B2", color = "white",font_size=12)
 
 # print(visual)




```

## Critical Action

```{r}

pi_action<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Critical Action")

# check factors
# unique(pi_action$response)

heatmap(pi_action,true_factors)
```


# Caring Families And Relationships

## Relationships And Support

```{r}

family_support<-question_sum(svy_df,svy_dd,domain="Caring Families And Relationships",variable_target="Relationships/Support")

# check factors
# unique(family_support$response)

df<-family_support%>%filter(question=="Q10a. How many adults really know what your sparks are and help you go after them?")%>%mutate(sub_question='')

count_factors<-c("None","One","Two","Three or more","Not Sure","Don't wish to answer")

heatmap(df,count_factors)

temp_family<-family_support%>%
  filter(!question%in% c("Q10a. How many adults really know what your sparks are and help you go after them?","Q12. Are you currently in school or have been in the past 12 months?"))%>%
  mutate(sub_question=ifelse(question=="Q12a. How true is this about you. At my school, there is a teacher or some other adult who really cares about me","There is a teacher or some other adult who really cares about me",sub_question),
                                     question="How true is this about you")

heatmap(temp_family,true_factors)

```

## Connectedness

```{r}

family_connection<-question_sum(svy_df,svy_dd,domain="Caring Families And Relationships",variable_target="Connectedness")

# check factors
# unique(family_connection$response)

heatmap(family_connection,true_factors)


```


# Cultural Identity

## Cultural Identity And Connection

```{r}

df_cultural<-question_sum(svy_df,svy_dd,domain="Cultural Identity",variable_target="Cultural Identity And Connection")


# check factors
# unique(df_cultural$response)

heatmap(df_cultural,true_factors)


```


# Safety

## Personal Safety

```{r}

df_safety<-question_sum(svy_df,svy_dd,domain="Safety",variable_target="Personal Safety")

# check factors
# unique(df_safety$response)

frequency_factors<-c("Never","Rarely","Sometimes","Most of the time","All of the time","Does not apply to me")

heatmap(df_safety%>%mutate(sub_question=''),frequency_factors)


```


# Vibrant Communities

## Safe Access To Public Spaces


```{r}

community_access<-question_sum(svy_df,svy_dd,domain="Vibrant Communities",variable_target="Safe Access To Public Spaces For Social, Cultural, And Literary Opportunities")


# check factors
# unique(community_access$response)

yes_factors_2<-c("No","Yes","Dont Know","Don't wish to answer")

heatmap(community_access,yes_factors_2)

```


# Racial Justice, Equity, And Inclusion

## Microaggressions

```{r}

equity_micro<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Microaggressions")

# check factors
# unique(equity_micro$response)


heatmap(equity_micro,frequency_factors)

```

## Experiences of Racism

```{r}

equity_experiences<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Experiences Of Racism And Discrimination")

# check factors
# unique(equity_experiences$response)


heatmap(equity_experiences,frequency_factors)

```


## Structural Racism

```{r}

equity_structural<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Structural Racism")


# check factors
# unique(equity_structural$response)


heatmap(equity_structural,frequency_factors)



```



```{r, echo=FALSE}

# Bind together all variables from every category/factor----
## Strong Minds -----
df_sm<-rbind(sm_psychologicaldistress,sm_growth_mindset,sm_positive_emotions)%>%mutate(domain="Strong Minds")

## Positive Identity ----
df_pi<-rbind(pi_action,pi_freedom,pi_hope,pi_self,pi_sparks)%>%mutate(domain='Positive Identity And Self-Worth')

## Caring Families and Relationships ----
df_family<-rbind(family_connection,family_support)%>%mutate(domain="Caring Families And Relationships")

## Cultural Identity ----
df_cultural<-df_cultural%>%mutate(domain="Cultural Identity")

## Safety ----
df_safety<-df_safety%>%mutate(domain="Safety")

## Vibrant Communities ----
df_community<-community_access%>%mutate(variable="Safe Access to Public Spaces",domain="Vibrant Communities")

## Racial Justice, Equity----
df_equity<-rbind(equity_micro,equity_experiences,equity_structural)%>%mutate(domain="Racial Justice, Equity, And Inclusion")


# Push tables to postgres ----

#### Strong Minds ----
# table_name <- "strong_minds_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_sm,
#              overwrite = FALSE, row.names = FALSE)
# 
# 
# #### Positive Identity and Self-Worth ----
# table_name <- "positive_identity_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_pi,
#              overwrite = FALSE, row.names = FALSE)
# 
# 
# #### Caring Families and Relationships ----
# table_name <- "caring_families_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_family,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Cultural Identity ----
# table_name <- "cultural_identity_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_cultural,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Safety ----
# table_name <- "safety_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_safety,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Vibrant Communities ----
# table_name <- "vibrant_community_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_community,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Racial Justice ----
# table_name <- "racial_justice_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_equity,
#              overwrite = FALSE, row.names = FALSE)

dbDisconnect(con)
```
