---
title: "Running survey demographics"
author: "Alicia Vo"
date: "2024-10-07"
output: html_document
---
## Purpose: Running survey demographics

# Pull data from database.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
library(data.table)
library(dplyr)
library(RPostgreSQL)
library(purrr)
library(stringr)
library(tibble)
library(tidyr)
library(devtools) 

# Connect to postgres
source("W:\\RDA Team\\R\\credentials_source.R")
con <- connect_to_db("bold_vision")

source("W:\\RDA Team\\R\\Github\\RDA Functions\\main\\RDA-Functions\\Utility_Functions.R")

# Pull in the data dictionary
svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024")

# Pull in the raw survey data 
svy_data <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")

# Pull in table of respondents with recoded race/ethnicity
race_ethnicity_data <- dbGetQuery(con, "SELECT * FROM youth_thriving.race_ethnicity_data")

total_respondents <- nrow(svy_data)
```

# Calculate the frequencies and percentages of Latinx and non-Hispanic race categories.
```{r}
nh_race_demographics_df <- race_ethnicity_data %>%
  count(nh_race) %>%  # Count occurrences of each unique value in the column
  rename(count = n, race=nh_race) %>%
  mutate(variable_name = 'Non-Hispanic race', percentage = count/total_respondents*100) %>%
  select(variable_name, everything())
```

# Calculate the frequencies and percentages of detailed races.
```{r}
detailed_race_demographics_df <- race_ethnicity_data %>%
  count(detailed_race) %>%  # Count occurrences of each unique value in the column
  rename(count = n) %>%
  mutate(variable_name = 'Detailed race', rate = count/total_respondents*100,
         detailed_race = ifelse(detailed_race == "", NA, detailed_race)) %>%
  arrange(desc(rate)) %>%  # Arrange by rate in descending order
  select(variable_name, everything())
```

# Calculate the frequencies and percentages of detailed Asian ethnicities.
```{r}
total_asian_aoic <- nrow(race_ethnicity_data%>%filter(race_asian==1))

# Includes NA where Asian respondents did not provide an answer to the detailed Asian question
asian_ethnicity_demographics_df <- race_ethnicity_data %>%
 filter(race_asian==1)%>% # Get all respondents who are Asian alone or in combination 
  count(detailed_asian) %>%  # Count occurrences of each unique value in the column
  rename(count = n) %>%
  mutate(variable_name = 'Asian detailed ethnicity', rate = count/total_asian_aoic*100,
         detailed_asian = ifelse(detailed_asian == "", NA, detailed_asian)) %>%
  arrange(desc(rate)) %>%  # Arrange by rate in descending order
  select(variable_name, everything())
```

# Calculate the frequencies and percentages of detailed NHPI ethnicities. 
# AV 10/22/24 Potential TODO: Edit detailed_nhpi column in recording_race.Rmd so that it adds the "Other NHPI" ethnicities as well - similar to the edits made to the detailed_asian column. For example, Filipino is not listed in this table, even though some Filipino respondents chose to identify as NHPI.
```{r}
total_nhpi_aoic <- nrow(race_ethnicity_data%>%filter(race_nhpi==1))

# Includes NA where NHPI respondents did not provide an answer to the detailed NHPI question
nhpi_ethnicity_demographics_df <- race_ethnicity_data %>%
 filter(race_nhpi==1)%>% # Get all respondents who are NHPI alone or in combination 
  count(detailed_nhpi) %>%  # Count occurrences of each unique value in the column
  rename(count = n) %>%
  mutate(variable_name = 'NHPI detailed ethnicity', rate = count/total_nhpi_aoic*100,
         detailed_nhpi = ifelse(detailed_nhpi == "", NA, detailed_nhpi)) %>%
  arrange(desc(rate)) %>%  # Arrange by rate in descending order
  select(variable_name, everything())
```

# Calculate the frequencies and percentages of gender identities.
```{r}
# vars contains the column names and response values of a question domain (e.g. race)
vars<-svy_dd %>% 
  filter(variable_name=='Gender') %>% 
  select(variable,response_1)

df <- svy_data %>%
  select(all_of(vars$variable)) %>%  # Select all of the question domain's columns in the raw data
  mutate(across(where(is.character), ~ ifelse(!is.na(.), 1, 0))) %>% # Convert non-numeric values to 0/1
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% # Sum up numeric columns, ignoring NA
  mutate(variable_name = 'Gender')

gender_demographics_df<-df %>% 
  pivot_longer(!variable_name,names_to='variable',values_to='count') %>%
  left_join(vars, by="variable") %>% 
  mutate(rate = count/total_respondents * 100) %>%
  select(variable_name, variable, response_1, count, rate)
```

# Calculate the frequencies and percentages of sexualities.
```{r}
# vars contains the column names and response values of a question domain (e.g. race)
vars<-svy_dd %>% 
  filter(variable_name=='Sexual Orientation') %>% 
  select(variable,response_1)

df <- svy_data %>%
  select(all_of(vars$variable)) %>%  # Select all of the question domain's columns in the raw data
  mutate(across(where(is.character), ~ ifelse(!is.na(.), 1, 0))) %>% # Convert non-numeric values to 0/1
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% # Sum up numeric columns, ignoring NA
  mutate(variable_name = 'Sexual Orientation')

sexuality_demographics_df<-df %>% 
  pivot_longer(!variable_name,names_to='variable',values_to='count') %>%
  left_join(vars, by="variable") %>% 
  mutate(rate = count/total_respondents * 100) %>%
  select(variable_name, variable, response_1, count, rate)
```

# Calculate frequencies and percentages for school type enrollment.
# AV 10/22/24: Awaiting revisions to codebook to run this table
```{r}
# education_demographics_df <- svy_data %>%
```

# Calculate frequencies and percentages of employment status.
# AV 10/22/24: Awaiting revisions to codebook to run this table
# DO NOT USE: the codebook has an error. instead of column bw being the "other" repsonses, column bz contains the "other" responses. this makes me unsure of what exactly the other columns are referring to. awaiting a response from the survey people.
```{r}
# employment_demographics_df <- svy_data %>%
```

```{r}
# # Bind the data frames into one long data frame
# education_employment_demographics <- bind_rows(
#   education_demographics_df,
#   employment_demographics_df)
```

# Calculate the frequencies and percentages of system involvement.
# Q24. At any point have you: Lived in foster care, spent time in juvenile hall or probation camp, spent time in jail or prison, lived in a group home or residential program, or lived with relatives who were responsible for you legally? 
```{r}
# System involvement out of all youth

# Total percentage of respondents who were ever system involved
ever_system_involved_demographics_df<-svy_data %>% 
  count(q24)%>%
  rename(count = n) %>%
  mutate(variable_name = 'Ever system involved', rate = count/total_respondents*100,
         variable="(q24) At any point system involved")%>%
  filter(q24==1)%>%
  select(variable_name, variable,everything(), -q24)

# System involved by type of system
# vars contains the column names and response values of a question domain 
vars<-svy_dd %>% 
  filter(variable_name=='System Involvement' & response_type=='tf') %>% # system involvement questions that were true false but not ones that were multiple choice - yes, no, don't know, etc.
  select(variable,response_1)

df <- svy_data %>%
  select(all_of(vars$variable)) %>%  # Select all of the system-involved columns in the raw data
  mutate(across(where(is.character), ~ ifelse(!is.na(.), 1, 0))) %>% # Convert specific non-numeric values
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% # Sum up numeric columns, ignoring NA
  mutate(variable_name = 'System Involvement Rates Amongst All Youth')

system_involved_by_type_demographics_df<-df %>% 
  pivot_longer(!variable_name,names_to='variable',values_to='count') %>%
  left_join(vars, by="variable") %>% 
  mutate(rate = count/total_respondents * 100) %>%
  select(variable_name, variable, response_1, count, rate)
```

```{r}
# This frequency table has rates for system involvement out of all system involved youth (instead of all respondents)
system_involved_total<- nrow(svy_data %>% filter(q24 == 1))

# Step 1: Filter respondents who answered "Yes" (1) to Q24
system_involved_data<- svy_data %>% filter(q24 == 1)

df <- system_involved_data  %>%
  select(all_of(vars$variable)) %>%  # Select all of the system involved columns in the raw data
  mutate(across(where(is.character), ~ ifelse(!is.na(.), 1, 0))) %>% # Convert specific non-numeric values
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% # Sum up numeric columns, ignoring NA
  mutate(variable_name = 'System Involvement Rates Amongst Systems-Impacted Youth')

system_involved_by_type_demographics_df_2<-df %>% 
  pivot_longer(!variable_name,names_to='variable',values_to='count') %>%
  left_join(vars, by="variable") %>% 
  mutate(rate = count/system_involved_total * 100) %>%
  select(variable_name, variable, response_1, count, rate)
```

# Calculate frequencies and percentages of law enforcement involvement.
# Q25. At any point, have you ever been detained AND/OR arrested by law enforcement in any capactiy?
```{r}
# Total percentage arrested ever
arrested_demographics_df<-svy_data %>% 
  count(q25)%>%
  rename(count = n) %>%
  mutate(variable_name = 'Law enforcement involvement', rate = count/total_respondents*100,
         variable="(q25) Ever been detained or arrested")%>%
  filter(q25==1)%>%
  select(variable_name, variable,everything(), -q25)
```

#Q26. At any point, have you ever been suspended, experienced an "opportunity transfer", been expelled, have been sent out of class by a teacher, had your parents contacted for a school-based incident, or arrested at school? 
```{r}
# Total percentage disciplined in school ever
school_discipline_demographics_df<-svy_data %>% 
  count(q26)%>%
  rename(count = n) %>%
  mutate(variable_name = 'Disciplined at school', rate = count/total_respondents*100,
         variable="(q26) Ever been suspended, experienced an opportunity transfer, expelled,
         sent out of class by a teacher, had your parents contacted for a school-based 
         incident, or arrested at school?")%>%
  filter(q26==1)%>%
  select(variable_name, variable,everything(), -q26)
```

# Calculate the frequencies and percentages of immigration system involvement. 
# Q27: Do any of the following apply to you: Temporary Protected Status, Asylum Status, Refugee Status, Differed Action for Childhood Arrivals (DACA), Non-Citizen Resident?
```{r}
# total percentage impacted by immigration systems-temporary status or undocumented
immigration_demographics_df<-svy_data %>% 
  count(q27)%>%
  rename(count = n) %>%
  mutate(variable_name = 'Immigration-system impacted', rate = count/total_respondents*100,
         variable="(q27) Temporary Protected Status, Asylum Status, Refugee Status, DACA, Non-Citizen Resident")%>%
  filter(q27==1)%>%
  select(variable_name, variable,everything(), -q27)
```
# Calculate the frequencies and percentages of unhoused. 
# Q28. In the past year, was there ever a time when you were homeless or had to stay in any of the following places: A shelter or emergency housing, garage, transitional housing program, motel or hotel, a car, a park, campground, another public place, trailer, motor home, temporarily in the home of a friend, family or another person?
```{r}
# total percentage unhoused in past year
unhoused_demographics_df<-svy_data %>% 
  count(q28)%>%
  rename(count = n) %>%
  mutate(variable_name = 'Housing Status', rate = count/total_respondents*100,
         variable="(q28) Was homeless or had to stay in any of the following places: 
         A shelter or emergency housing, garage, transitional housing program, 
         motel or hotel, a car, a park, campground, another public place, trailer, 
         motor home, temporarily in the home of a friend, family or another 
         person in the past year?")%>%
  filter(q28==1)%>%
  select(variable_name, variable,everything(), -q28)
```

```{r}
# Bind the system involved data frames into one long data frame
system_involvement_demographics <- bind_rows(
  ever_system_involved_demographics_df,
  system_involved_by_type_demographics_df,
  system_involved_by_type_demographics_df_2,
  arrested_demographics_df,
  school_discipline_demographics_df,
  immigration_demographics_df,
  unhoused_demographics_df)

system_involvement_demographics <- system_involvement_demographics %>% 
  mutate(response_1 = ifelse(is.na(response_1), "Yes", response_1))%>% 
  select(variable_name, variable, response_1, everything())
```

# Export nh_race_demographics_df dataframe as a table 
```{r}
# Write table nh_race_demographics_df with metadata
schema <- "youth_thriving"
table_name <- "race_nh_demographics"
indicator <- "Frequencies and percentages of non-Hispanic race categories"
source <- "script: W:/Project/OSI/Bold Vision/Youth Thriving Survey/GitHub/AV/boldvision_youththriving/getting_demographics.Rmd"
qa_filepath <- "W:/Project/OSI/Bold Vision/Youth Thriving Survey/Documentation/QA_getting_demographics"
table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), nh_race_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for nh_race_demographics_df
column_names <- colnames(nh_race_demographics_df) # Get column names
column_comments <- c(
  'This table uses non-Hispanic race categories',
  'This column has all of the non-Hispanic race categories',
  'Denotes the number of respondents with the corresponding racial identity',
  'Denotes the percentage of respondents with the corresponding racial identity')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```
# Export detailed_race_demographics_df dataframe as a table 
```{r}
# Write table detailed_race_demographics_df with metadata
schema <- "youth_thriving"
table_name <- "race_detailed_demographics"
indicator <- "Frequencies and percentages of detailed race categories, including mixed races"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), detailed_race_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for detailed_race_demographics_df
column_names <- colnames(detailed_race_demographics_df) # Get column names
column_comments <- c(
  'This table uses detailed race categories',
  'This column has all of the detailed race categories',
  'Denotes the number of respondents with the corresponding racial identity',
  'Denotes the percentage of respondents with the corresponding racial identity')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```

# Export asian_ethnicity_demographics_df dataframe as a table 
```{r}
# Write table asian_ethnicity_demographics_df with metadata
schema <- "youth_thriving"
table_name <- "asian_ethnicity_demographics"
indicator <- "Frequencies and percentages of detailed Asian ethnicity categories"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), asian_ethnicity_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for asian_ethnicity_demographics_df
column_names <- colnames(asian_ethnicity_demographics_df) # Get column names
column_comments <- c(
  'This table uses detailed Asian ethnic categories',
  'This column has all of the Asian ethnic categories',
  'Denotes the number of respondents with the corresponding ethnic identity',
  'Denotes the percentage of respondents with the corresponding ethnic identity')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```
# Export nhpi_ethnicity_demographics_df dataframe as a table 
```{r}
# Write table nhpi_ethnicity_demographics_df with metadata
schema <- "youth_thriving"
table_name <- "nhpi_ethnicity_demographics"
indicator <- "Frequencies and percentages of detailed NHPI ethnicity categories"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), nhpi_ethnicity_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for nhpi_ethnicity_demographics_df
column_names <- colnames(nhpi_ethnicity_demographics_df) # Get column names
column_comments <- c(
  'This table uses detailed NHPI ethnic categories',
  'This column has all of the NHPI ethnic categories',
  'Denotes the number of respondents with the corresponding ethnic identity',
  'Denotes the percentage of respondents with the corresponding ethnic identity')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```

# Export gender_demographics_df dataframe as a table with comments
```{r}
# Write table gender_sexuality_demographics with metadata
schema <- "youth_thriving"
table_name <- "gender_demographics"
indicator <- "Frequencies and percentages of gender groups"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), gender_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for gender_demographics
column_names <- colnames(gender_demographics_df) # Get column names
column_comments <- c(
  'This table uses gender categories',
  'Name of the corresponding response column in the raw survey data',
  'All the possible gender responses',
  'Denotes the number of respondents with the corresponding gender identity',
  'Denotes the percentage of respondents with the corresponding gender identity')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```
# Export sexuality_demographics_df dataframe as a table with comments
```{r}
# Write table sexuality_demographics with metadata
schema <- "youth_thriving"
table_name <- "sexuality_demographics"
indicator <- "Frequencies and percentages of sexuality groups"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), sexuality_demographics_df,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for sexuality_demographics
column_names <- colnames(sexuality_demographics_df) # Get column names
column_comments <- c(
  'This table uses sexuality categories',
  'Name of the corresponding response column in the raw survey data',
  'All the possible sexuality responses',
  'Denotes the number of respondents with the corresponding sexuality',
  'Denotes the percentage of respondents with the corresponding sexuality')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```

# Export education_employment_demographics dataframe as a table with comments
```{r}
# # Write table education_employment_demographics with metadata
# schema <- "youth_thriving"
# table_name <- "education_employment_demographics"
# indicator <- "Frequencies and percentages of education and employment groups"

# table_comment <- paste0(indicator, source)
# dbWriteTable(con, c(schema, table_name), education_employment_demographics,
#              overwrite = TRUE, row.names = FALSE)
# 
# # Add metadata for education_employment_demographics
# column_names <- colnames(education_employment_demographics) # Get column names
# column_comments <- c(
#   'The columns called [insert school type]_count give the number of respondents who attend the specified school type',
#   'The columns called [insert school type]_pct give the percentage of respondents who attend the specified school type')
# 
# add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```

# Export system_involvement_demographics dataframe as a table with comments
```{r}
# Write table system_involvement_demographics with metadata
schema <- "youth_thriving"
table_name <- "system_involvement_demographics"
indicator <- "Frequencies and percentages of system involved groups"

table_comment <- paste0(indicator, source)
dbWriteTable(con, c(schema, table_name), system_involvement_demographics,
             overwrite = TRUE, row.names = FALSE)

# Add metadata for system_involvement_demographics
column_comments <- c(
  'This table uses system involved categories',
  'Name of the corresponding response column in the raw survey data',
  'The response options',
  'Denotes the number of respondents with the corresponding response',
  'Denotes the percentage of respondents with the corresponding response')

add_table_comments(con, schema, table_name, indicator, source, qa_filepath, column_names, column_comments) 
```

```{r}
dbDisconnect(con)
```