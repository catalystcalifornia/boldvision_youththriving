---
title: Bold Vision Youth Thriving Survey 
subtitle: Frequencies and Trends by Question and Category
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

### Step 1: Environment set up ----

library(data.table)
library(dplyr)
library(RPostgreSQL)
library(sf)
library(tidyr)
library(readxl)
library(tidyverse)
library(janitor)
library(srvyr)
library(survey)
library(highcharter)
library(knitr)
library(kableExtra)
library(devtools) 
options(scipen=999)

# connect to postgres and source functions
source("W:\\RDA Team\\R\\credentials_source.R")
# source_url('https://github.com/catalystcalifornia/RDA-Functions/blob/main/Utility_Functions.R') 

con <- connect_to_db("bold_vision")

### Step 2: Pull in and prep data ----
svy_df <- dbGetQuery(con, "SELECT * FROM youth_thriving.raw_survey_data")
svy_dd <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 WHERE response_type = 'mc'")
dd_all <- dbGetQuery(con, "SELECT * FROM youth_thriving.bvys_datadictionary_2024 ")

# Descriptive Function -----
question_sum<-function (svy_df,svy_dd,domain,variable_target) {
df <- svy_dd%>%filter(response_domain==domain & variable_name==variable_target)

unique_vars <- unique(df$variable)

mylist<-list()

for (i in unique_vars) {

  dict <- df %>% filter(variable == i) %>%
    pivot_longer(cols = response_1: response_12,
                 names_to = "response_numbers",
                 values_to = "response",
                 values_drop_na = TRUE)

  dict_var <- dict %>%
    mutate(variable_merge_col = 1:nrow(dict))

  df_var<-svy_df%>%as_survey(weights=c(weights_final))%>%
    filter(!is.na(!!as.symbol(i)))%>%
    group_by(!!rlang::ensym(i))%>%
    summarise(frequency=n(),percent=survey_mean(vartype="cv",level=.90))%>%
    mutate(percent=percent*100,percent_cv=percent_cv*100)%>%
    rename(weighted_percent=percent)

  df_final <-  merge(x = df_var, y = dict_var, by.x = c(i), by.y = c("variable_merge_col"))%>%
    select(question,sub_question,response,frequency,weighted_percent,percent_cv)
 
  df_table<-df_final%>%rename_with(toupper)%>%rename(PERCENT=WEIGHTED_PERCENT)
  colnames(df_table)<-gsub("_", " ", colnames(df_table))
  
 visual <- kable(as.data.frame(df_table)%>% 
   mutate_if(is.numeric, format, digits=2)) %>%
  kable_styling("striped", full_width = F) %>%
  row_spec(0, background = "#2A12B2", color = "white",font_size=12)%>%
   footnote(general="Frequencies are unweighted counts. Percentages and coefficients of variation (CV) are weighted")


  print(visual) 
  mylist[[i]] <- df_final

# print(mylist)
  }
all_vars_df<-dplyr::bind_rows(mylist)%>%mutate(variable=variable_target)
# return(all_vars_df)
}


# function test
# question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Positive Emotions")


```


# Strong Minds

## Positive Emotions

```{r}

sm_positive_emotions<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Positive Emotions")

```

## Growth Mindset

```{r}

sm_growth_mindset<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Growth Mindset")

```

## Psychological Distress

```{r}

sm_psychologicaldistress<-question_sum(svy_df,svy_dd,domain="Strong Minds",variable_target="Psychological Distress")

# bind together all variables from factor
df_sm<-rbind(sm_psychologicaldistress,sm_growth_mindset,sm_positive_emotions)%>%mutate(domain="Strong Minds")

```

# Positive Identity And Self-Worth

## Self-Efficacy

```{r}

pi_self<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Self-Efficacy")

```

## Hope For The Future

```{r}

pi_hope<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Hope For The Future")

```

## Freedom To Explore Self

```{r}

pi_freedom<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Freedom To Explore The Self")

```

## Sparks

```{r}

pi_sparks<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Sparks")

```

## Critical Action

```{r}

pi_action<-question_sum(svy_df,svy_dd,domain="Positive Identity And Self-Worth",variable_target="Critical Action")

df_pi<-rbind(pi_action,pi_freedom,pi_hope,pi_self,pi_sparks)%>%mutate(domain='Positive Identity And Self-Worth')
```


# Caring Families And Relationships

## Relationships And Support

```{r}

family_support<-question_sum(svy_df,svy_dd,domain="Caring Families And Relationships",variable_target="Relationships/Support")

```

## Connectedness

```{r}

family_connection<-question_sum(svy_df,svy_dd,domain="Caring Families And Relationships",variable_target="Connectedness")


df_family<-rbind(family_connection,family_support)%>%mutate(domain="Caring Families And Relationships")
```


# Cultural Identity

## Cultural Identity And Connection

```{r}

df_cultural<-question_sum(svy_df,svy_dd,domain="Cultural Identity",variable_target="Cultural Identity And Connection")

df_cultural<-df_cultural%>%mutate(domain="Cultural Identity")

```


# Safety

## Personal Safety

```{r}

df_safety<-question_sum(svy_df,svy_dd,domain="Safety",variable_target="Personal Safety")

df_safety<-df_safety%>%mutate(domain="Safety")

```


# Vibrant Communities

## Safe Access To Public Spaces


```{r}

community_access<-question_sum(svy_df,svy_dd,domain="Vibrant Communities",variable_target="Safe Access To Public Spaces For Social, Cultural, And Literary Opportunities")

df_community<-community_access%>%mutate(variable="Safe Access to Public Spaces",domain="Vibrant Communities")

```


# Racial Justice, Equity, And Inclusion

## Microaggressions

```{r}

equity_micro<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Microaggressions")

```

## Experiences of Racism

```{r}

equity_experiences<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Experiences Of Racism And Discrimination")

```


## Structural Racism

```{r}

equity_structural<-question_sum(svy_df,svy_dd,domain="Racial Justice, Equity, And Inclusion",variable_target="Structural Racism")

df_equity<-rbind(equity_micro,equity_experiences,equity_structural)%>%mutate(domain="Racial Justice, Equity, And Inclusion")

```



```{r, echo=FALSE}

# Push tables to postgres ----

#### Strong Minds ----
# table_name <- "strong_minds_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_sm,
#              overwrite = FALSE, row.names = FALSE)
# 
# 
# #### Positive Identity and Self-Worth ----
# table_name <- "positive_identity_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_pi,
#              overwrite = FALSE, row.names = FALSE)
# 
# 
# #### Caring Families and Relationships ----
# table_name <- "caring_families_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_family,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Cultural Identity ----
# table_name <- "cultural_identity_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_cultural,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Safety ----
# table_name <- "safety_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_safety,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Vibrant Communities ----
# table_name <- "vibrant_community_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_community,
#              overwrite = FALSE, row.names = FALSE)
# 
# #### Racial Justice ----
# table_name <- "racial_justice_frequencies"
# schema <- 'youth_thriving'
# 
# # write table
# dbWriteTable(con, c(schema, table_name),df_equity,
#              overwrite = FALSE, row.names = FALSE)

dbDisconnect(con)
```
